from flask import Flask, render_template, jsonify, request
from datetime import datetime, timedelta

app = Flask(__name__)

# Helper function to get today's date string
def get_today():
    return datetime.now().strftime('%Y-%m-%d')

def get_formatted_date(date_str=None):
    if date_str:
        date_obj = datetime.strptime(date_str, '%Y-%m-%d')
    else:
        date_obj = datetime.now()
    return date_obj.strftime('%B %d, %Y')

# Study sessions with proper date/time structure
study_sessions = [
    {
        "id": 1,
        "title": "Calculus II",
        "subject": "calculus",
        "date": get_today(),
        "startTime": "09:00",
        "endTime": "11:00",
        "color": "blue",
        "priority": "high",
        "notes": ""
    },
    {
        "id": 2,
        "title": "Linear Algebra",
        "subject": "algebra",
        "date": get_today(),
        "startTime": "11:00",
        "endTime": "12:30",
        "color": "cyan",
        "priority": "medium",
        "notes": ""
    },
    {
        "id": 3,
        "title": "Physics I Lab",
        "subject": "physics",
        "date": get_today(),
        "startTime": "14:00",
        "endTime": "16:15",
        "color": "blue",
        "priority": "high",
        "notes": ""
    },
    {
        "id": 4,
        "title": "Chemistry Basics",
        "subject": "chemistry",
        "date": get_today(),
        "startTime": "16:30",
        "endTime": "17:30",
        "color": "green",
        "priority": "medium",
        "notes": ""
    },
    {
        "id": 5,
        "title": "Literature Analysis",
        "subject": "literature",
        "date": get_today(),
        "startTime": "18:00",
        "endTime": "19:00",
        "color": "yellow",
        "priority": "low",
        "notes": ""
    },
]

# Tasks with proper date structure
today = datetime.now()
upcoming_tasks = [
    {"id": 1, "title": "Complete Calculus II homework", "dueDate": today.strftime('%Y-%m-%d'), "completed": False},
    {"id": 2, "title": "Read Chapter 5 of 'Physics I'", "dueDate": (today + timedelta(days=1)).strftime('%Y-%m-%d'), "completed": False},
    {"id": 3, "title": "Prepare for Linear Algebra quiz", "dueDate": (today + timedelta(days=2)).strftime('%Y-%m-%d'), "completed": False},
    {"id": 4, "title": "Review Chemistry Lab Report", "dueDate": (today + timedelta(days=3)).strftime('%Y-%m-%d'), "completed": True},
    {"id": 5, "title": "Outline Literature Essay", "dueDate": (today + timedelta(days=4)).strftime('%Y-%m-%d'), "completed": False},
]

# Focus session tracking (completed focus sessions)
focus_sessions = [
    {"date": (today - timedelta(days=5)).strftime('%Y-%m-%d'), "duration": 120, "subject": "Calculus II"},
    {"date": (today - timedelta(days=4)).strftime('%Y-%m-%d'), "duration": 90, "subject": "Physics I"},
    {"date": (today - timedelta(days=3)).strftime('%Y-%m-%d'), "duration": 60, "subject": "Chemistry"},
    {"date": (today - timedelta(days=2)).strftime('%Y-%m-%d'), "duration": 75, "subject": "Linear Algebra"},
    {"date": (today - timedelta(days=1)).strftime('%Y-%m-%d'), "duration": 45, "subject": "Literature"},
]
current_focus_session = None

ai_recommendations = [
    "Consider reviewing past Calculus II problems for 15 minutes before your next session.",
    "Your current study intensity for Linear Algebra is high; ensure you take short breaks.",
    "Explore additional resources on quantum mechanics for Physics I to deepen understanding.",
    "Utilize flashcards for Chemistry terms; spaced repetition is highly effective.",
    "Try active recall techniques for Literature analysis to improve retention."
]

def format_time_12h(time_24h):
    """Convert 24h time to 12h format"""
    hour, minute = map(int, time_24h.split(':'))
    period = 'AM' if hour < 12 else 'PM'
    hour_12 = hour % 12 or 12
    return f"{hour_12}:{minute:02d} {period}"

def calculate_duration(start_time, end_time):
    """Calculate duration between two times"""
    start_h, start_m = map(int, start_time.split(':'))
    end_h, end_m = map(int, end_time.split(':'))
    total_minutes = (end_h * 60 + end_m) - (start_h * 60 + start_m)
    hours = total_minutes // 60
    minutes = total_minutes % 60
    if hours == 0:
        return f"{minutes} min"
    elif minutes == 0:
        return f"{hours} hour{'s' if hours > 1 else ''}"
    else:
        return f"{hours} hour{'s' if hours > 1 else ''} {minutes} min"

def get_sessions_for_date(date_str):
    """Get sessions formatted for display on a specific date"""
    sessions = [s for s in study_sessions if s['date'] == date_str]
    formatted = []
    for s in sorted(sessions, key=lambda x: x['startTime']):
        formatted.append({
            'id': s['id'],
            'time': format_time_12h(s['startTime']),
            'subject': s['title'],
            'duration': calculate_duration(s['startTime'], s['endTime']),
            'color': s['color'],
            'startTime': s['startTime'],
            'endTime': s['endTime']
        })
    return formatted

def format_task_due(due_date_str):
    """Format task due date relative to today"""
    due_date = datetime.strptime(due_date_str, '%Y-%m-%d').date()
    today_date = datetime.now().date()
    diff = (due_date - today_date).days

    if diff == 0:
        return "Due: Today"
    elif diff == 1:
        return "Due: Tomorrow"
    elif diff < 0:
        return f"Overdue: {abs(diff)} day{'s' if abs(diff) > 1 else ''}"
    else:
        return f"Due: {due_date.strftime('%b %d')}"

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/dashboard')
def dashboard():
    today_str = get_today()
    formatted_sessions = get_sessions_for_date(today_str)

    # Format tasks with relative due dates
    formatted_tasks = []
    for task in upcoming_tasks:
        formatted_tasks.append({
            **task,
            'due': format_task_due(task['dueDate'])
        })

    return render_template('dashboard.html',
                         sessions=formatted_sessions,
                         tasks=formatted_tasks,
                         recommendations=ai_recommendations,
                         current_date=get_formatted_date())

@app.route('/planner')
def planner():
    return render_template('planner.html',
                          current_date=get_today(),
                          formatted_date=get_formatted_date())

@app.route('/features')
def features():
    return render_template('features.html')

@app.route('/progress')
def progress():
    return render_template('progress.html')

@app.route('/settings')
def settings():
    return render_template('settings.html')

# API Endpoints

@app.route('/api/sessions', methods=['GET', 'POST'])
def handle_sessions():
    if request.method == 'POST':
        new_session = request.json
        new_session['id'] = max([s['id'] for s in study_sessions], default=0) + 1
        study_sessions.append(new_session)
        return jsonify(new_session), 201

    # GET - optionally filter by date
    date_filter = request.args.get('date')
    if date_filter:
        filtered = [s for s in study_sessions if s['date'] == date_filter]
        return jsonify(filtered)
    return jsonify(study_sessions)

@app.route('/api/sessions/<int:session_id>', methods=['GET', 'PUT', 'DELETE'])
def handle_session(session_id):
    global study_sessions
    session = next((s for s in study_sessions if s['id'] == session_id), None)

    if request.method == 'DELETE':
        study_sessions = [s for s in study_sessions if s['id'] != session_id]
        return jsonify({'success': True})

    if request.method == 'PUT':
        if session:
            update_data = request.json
            session.update(update_data)
            return jsonify(session)
        return jsonify({'error': 'Session not found'}), 404

    if session:
        return jsonify(session)
    return jsonify({'error': 'Session not found'}), 404

@app.route('/api/sessions/formatted', methods=['GET'])
def get_formatted_sessions():
    """Get sessions formatted for dashboard display"""
    date_filter = request.args.get('date', get_today())
    return jsonify(get_sessions_for_date(date_filter))

@app.route('/api/tasks', methods=['GET', 'POST'])
def handle_tasks():
    if request.method == 'POST':
        new_task = request.json
        new_task['id'] = max([t['id'] for t in upcoming_tasks], default=0) + 1
        new_task['completed'] = False
        upcoming_tasks.append(new_task)
        return jsonify({**new_task, 'due': format_task_due(new_task['dueDate'])}), 201

    # Return tasks with formatted due dates
    formatted = [{**t, 'due': format_task_due(t['dueDate'])} for t in upcoming_tasks]
    return jsonify(formatted)

@app.route('/api/tasks/<int:task_id>/toggle', methods=['POST'])
def toggle_task(task_id):
    task = next((t for t in upcoming_tasks if t['id'] == task_id), None)
    if task:
        task['completed'] = not task['completed']
        return jsonify({**task, 'due': format_task_due(task['dueDate'])})
    return jsonify({'error': 'Task not found'}), 404

@app.route('/api/tasks/<int:task_id>', methods=['DELETE'])
def delete_task(task_id):
    global upcoming_tasks
    upcoming_tasks = [t for t in upcoming_tasks if t['id'] != task_id]
    return jsonify({'success': True})

@app.route('/api/dashboard/stats', methods=['GET'])
def get_dashboard_stats():
    completed_tasks = sum(1 for t in upcoming_tasks if t['completed'])
    total_tasks = len(upcoming_tasks)
    completion_rate = (completed_tasks / total_tasks * 100) if total_tasks > 0 else 0

    # Calculate focus time stats
    total_minutes = sum(session['duration'] for session in focus_sessions)
    total_hours = total_minutes // 60
    total_mins = total_minutes % 60

    avg_minutes = total_minutes // len(focus_sessions) if focus_sessions else 0
    avg_hours = avg_minutes // 60
    avg_mins = avg_minutes % 60

    # Calculate streak
    longest_streak = calculate_longest_streak()

    # Calculate missed sessions (sessions where start time has passed today)
    now = datetime.now()
    today_str = get_today()
    current_time = now.strftime('%H:%M')
    missed_sessions = 0
    for session in study_sessions:
        if session['date'] == today_str and session['startTime'] < current_time:
            # Check if there's a corresponding focus session for this time
            session_completed = False
            for fs in focus_sessions:
                if fs.get('date') == today_str and fs.get('subject') == session.get('title'):
                    session_completed = True
                    break
            if not session_completed:
                missed_sessions += 1

    return jsonify({
        'completedTasks': completed_tasks,
        'totalTasks': total_tasks,
        'completionRate': round(completion_rate),
        'totalFocusTime': f"{total_hours}h {total_mins}m",
        'averageSession': f"{avg_hours}h {avg_mins}m",
        'longestStreak': f"{longest_streak} days",
        'totalFocusMinutes': total_minutes,
        'sessionCount': len(focus_sessions),
        'missedSessions': missed_sessions
    })

@app.route('/api/progress/stats', methods=['GET'])
def get_progress_stats():
    """Get comprehensive progress statistics"""
    # Task stats
    completed_tasks = sum(1 for t in upcoming_tasks if t['completed'])
    total_tasks = len(upcoming_tasks)

    # Focus time stats
    total_minutes = sum(session['duration'] for session in focus_sessions)
    total_hours = total_minutes // 60

    # Subject breakdown
    subject_times = {}
    for session in focus_sessions:
        subject = session['subject']
        subject_times[subject] = subject_times.get(subject, 0) + session['duration']

    # Weekly data for charts
    today = datetime.now()
    weekly_data = []
    for i in range(6, -1, -1):
        day = today - timedelta(days=i)
        day_str = day.strftime('%Y-%m-%d')
        day_sessions = [s for s in focus_sessions if s['date'] == day_str]
        weekly_data.append({
            'date': day_str,
            'dayName': day.strftime('%a'),
            'minutes': sum(s['duration'] for s in day_sessions),
            'sessions': len(day_sessions)
        })

    # Monthly task completion data
    monthly_data = []
    for i in range(4, -1, -1):
        month = today - timedelta(days=i*30)
        month_name = month.strftime('%b')
        # Simulated data for chart
        monthly_data.append({
            'month': month_name,
            'completed': 30 + (4-i) * 5,
            'total': 50 + (4-i) * 3
        })

    return jsonify({
        'totalTasksCompleted': completed_tasks,
        'totalTasks': total_tasks,
        'totalStudyHours': total_hours,
        'totalStudyMinutes': total_minutes,
        'subjectsStudied': len(subject_times),
        'currentStreak': calculate_longest_streak(),
        'subjectBreakdown': subject_times,
        'weeklyData': weekly_data,
        'monthlyData': monthly_data
    })

@app.route('/api/focus/start', methods=['POST'])
def start_focus_session():
    global current_focus_session
    current_focus_session = {
        'start_time': datetime.now().isoformat(),
        'subject': request.json.get('subject', 'General Study')
    }
    return jsonify({'success': True, 'session': current_focus_session})

@app.route('/api/focus/end', methods=['POST'])
def end_focus_session():
    global current_focus_session, focus_sessions

    if not current_focus_session:
        return jsonify({'error': 'No active session'}), 400

    start_time = datetime.fromisoformat(current_focus_session['start_time'])
    end_time = datetime.now()
    duration_minutes = int((end_time - start_time).total_seconds() / 60)

    session_record = {
        'start_time': current_focus_session['start_time'],
        'end_time': end_time.isoformat(),
        'duration': duration_minutes,
        'subject': current_focus_session['subject'],
        'date': end_time.strftime('%Y-%m-%d')
    }

    focus_sessions.append(session_record)
    current_focus_session = None

    return jsonify({
        'success': True,
        'session': session_record,
        'duration_minutes': duration_minutes
    })

@app.route('/api/focus/current', methods=['GET'])
def get_current_session():
    return jsonify({
        'active': current_focus_session is not None,
        'session': current_focus_session
    })

@app.route('/api/focus/history', methods=['GET'])
def get_focus_history():
    return jsonify(focus_sessions)

@app.route('/api/date/current', methods=['GET'])
def get_current_date():
    """Get current date info"""
    today = datetime.now()
    return jsonify({
        'date': today.strftime('%Y-%m-%d'),
        'formatted': today.strftime('%B %d, %Y'),
        'dayName': today.strftime('%A')
    })

def calculate_longest_streak():
    if not focus_sessions:
        return 0

    dates = set(session['date'] for session in focus_sessions)
    if not dates:
        return 0

    sorted_dates = sorted([datetime.strptime(d, '%Y-%m-%d') for d in dates])

    longest = 1
    current = 1

    for i in range(1, len(sorted_dates)):
        if (sorted_dates[i] - sorted_dates[i-1]).days == 1:
            current += 1
            longest = max(longest, current)
        else:
            current = 1

    return longest

if __name__ == '__main__':
    app.run(debug=True, port=5000)
